---
title: Making Network Animations Using NDTV package
author: ~
date: '2020-05-27'
slug: making-network-animations-using-ndtv-package
categories:
  - R
  - Networks
  
tags:

subtitle: ''
summary: ''
authors: []
lastmod: '2020-05-27T18:00:41-05:00'
featured: no
image:
  caption: ''
  focal_point: ''
  preview_only: no
url_video: "rivndtv.mp4"
projects: []
---

The following commands are for making a network animation (moving networks) using R packages `statnet` and `ndtv`.

### Step 1: Load packages

I use the following packages to make a network gif. `statnet` and `ndtv` packages are necessary but you can use other packages instead of `rio` to load data. I prefer `rio` because the command is simple. What we need to do is type 'import'.

```{r setup, warning = FALSE, message = FALSE}
library(statnet)
library(ndtv)
library(rio)
```


### Step 2: Load data

I'll make a network gif for the formation and dissolution of interstate rivalry from 1987 to 2002 with 5-year intervals (four time points). So, two pieces of information are necessary: 1) a list of rivalries for the given time points, and 2) a list of countries. The current version of `ndtv` package doesn't allow varying numbers of vertices, which means the number of vertices must be the same for all time points. Indeed, some countries newly appeared and others were gone from 1987 to 2002. However, because of the limitation, I put all countries which existed for the given period in my node list (node.csv). 

Additionally, I'll color the countries using their geographical location. For the color of the nodes, I'll use COW country code, which is included in 'vtx1987.csv' file below.  

You can find these toy datasets from my [github](https://github.com/bomibonnie/website-hugo/tree/master/content/post).


```{r data, warning = FALSE, message = FALSE}
riv <- import("C:/Users/bomim/Documents/website-hugo/content/post/toyriv.dta")
vtx <- import("C:/Users/bomim/Documents/website-hugo//content/post/node.csv")
vtx87 <- import("C:/Users/bomim/Documents/website-hugo/content/post/vtx1987.csv")

```

### Step 3: Look at the data

Let's look at the data we loaded in the previous step. The object 'riv' is the list of rivalries in the given time points. 'riv' has four columns: year, stateabb1, stateabb2, and no. Since rivalries are not directed (if Country A is Country B's rival, then Country B is Country A's rival as well), the order of stateabb1 and stateabb2 doesn't matter. I'll use 'no' variable to identify the time points but you can use 'year' instead.

Because our edge list (the list of rivalries) is made using stateabb (i.e., AAB, AFG, ALB...), our node list must be a list of stateabb. 

For the color of nodes, I add more info to the object, 'vtx87'. The nodes will be matched using the 'stateabb' variable.

```{r dataex, warning = FALSE, message = FALSE, tidy=TRUE}
head(riv)
head(vtx)
head(vtx87)
```

### Step 4: Make a list of networks

I use for loop to make a rivalry network for each time point. Briefly, I make an object of list (rivlist) and put rivalry networks for four time points in the list.

* More details

The object, 'nv', is the numeric value, which shows the total number of countries (204 countries in my node list). 

Let's look at the for loop chunk. This is for making a rivalry network for each time point. I use 'no' variable to identify the time points. When i is equal to 1, all rivalries in 1987 (rivi) and two columns from rivi (stateabb1 and stateabb2) would be selected (rivii). 

Using the nv (204L), I make an empty network (network.initialize). Since there is no direction in rivalry networks, the option, directed is FALSE. If your networks of interest are directed, change the option to TRUE. For the network made, I add the vertex names using the command, 'network.vertex.names'. Now the vertices in the network have their names (stateabb) but still there are no ties. Information about ties is loaded from the object, rivii. The next line is optional. I add info about time points as a vertex attribute (order). This sequence is repeated for four time points.


```{r network, warning = FALSE, message = FALSE}
nv <- nrow(vtx)

rivlist <- list()

for(i in 1:4){
  rivi <- subset(riv, riv$no == i)
  rivii<-cbind(rivi$stateabb1, rivi$stateabb2)
  netyr <- network.initialize(nv, directed=FALSE)
  network.vertex.names(x=netyr) <- vtx$stateabb
  netyr[rivii] <- 1
  set.vertex.attribute(x=netyr,attrname="order",val=rep(i,nv))
  rivlist[[i]] <- netyr
}
```

* Set vertex attribute

As shown in the previous step, we can use the command, 'set.vertex.attribute', to add vertex attributes to the network. Following commands are for the color of nodes. 

From 'vtx87', I add more info such as COW country code and CINC score for each country in the network. I use the COW country code for the color of nodes: red for Americas, orange for Europe, yellow for Africa, green for Middle East, and blue for Asia and Oceania. If you want to color the nodes, you'd better to choose one of the variables which rarely varies over time such as geographical location for countries and gender for individuals. Although `ndtv` shows changes in networks such as newly appearing and disappearing ties, it doesn't allow changes in nodal attributes. For instance, let's say you want to color nodes depending on the regime type such as democracy/non-democracy. If Country A moved to democracy from non-democracy in the middle (like time point 2 or 3), its change cannot be reflected in the network gif.


```{r network_attribute, warning = FALSE, message = FALSE}
set.vertex.attribute(rivlist[[1]],names(vtx87),vtx87)

cols1<-vector()
for(i in 1:204){
  ifelse(rivlist[[1]]$val[[i]]$ccode<200, cols1[i] <- "red", 
         ifelse((rivlist[[1]]$val[[i]]$ccode>=200)&(rivlist[[1]]$val[[i]]$ccode<400), cols1[i]<-"orange",
                ifelse((rivlist[[1]]$val[[i]]$ccode>=400)&(rivlist[[1]]$val[[i]]$ccode<630), cols1[i]<-"yellow",
                       ifelse((rivlist[[1]]$val[[i]]$ccode>=630)&(rivlist[[1]]$val[[i]]$ccode<700),cols1[i]<-"green", cols1[i]<-"blue"))))
}
```

** You can find more commands for data management in R [here](https://github.com/bomibonnie/R-Workshops) from my github. 

* Make a plot 

Let's look at the rivalry network in 1987 (time point 1). I use the vector of colors for this plot. 

```{r plot, warning = FALSE, message = FALSE}
plot(rivlist[[1]], 
     vertex.col=cols1, 
     edge.col="grey50",
     xpd=T)
```


### Step 5: Make GIFs!

Almost there! We use the network list (rivlist) to make a networkDynamic object, rivdyn. Before we render an animation, we need one more step here. By using the 'compute.animation' command, we can set intervals, animation layout, etc.

```{r dynamics, warning = FALSE, message = FALSE, eval=FALSE}
rivdyn <- networkDynamic(network.list = rivlist)
rivgif <- compute.animation(rivdyn, 
                            animation.mode = "kamadakawai",
                            verbose = FALSE)

```

This is the last step. Use the 'render.d3movie' command to make a network gif! I add the color vector for this gif!


```{r gif, warning = FALSE, message = FALSE, eval=FALSE}
render.d3movie(rivgif,
               displaylables=FALSE, 
               vertex.col=cols1)
```

More information about `ndtv` can be found [here](https://rdrr.io/cran/ndtv/f/inst/doc/ndtv.pdf).


{{% alert note %}}
You can look at the network gif by clicking **Video** button above.
{{% /alert %}}